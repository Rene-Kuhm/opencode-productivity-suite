# Zero Defect Pre-Commit Gates Configuration
# NO COMMITS ALLOWED without passing ALL gates

gates:
  mandatory:
    # Type Safety Gate - ZERO tolerance
    - name: "Type Safety Validation"
      command: "smart_typecheck --ultra-strict"
      blocking: true
      timeout: 60
      description: "ZERO TypeScript errors allowed"
      failure_action: "block"
      success_criteria:
        - "0 type errors"
        - "0 'any' types detected" 
        - "strict mode compliance"

    # Security Gate - OWASP Compliance
    - name: "Security Vulnerability Scan"
      command: "@security-auditor --comprehensive-scan"
      blocking: true
      timeout: 120
      description: "OWASP compliance required"
      failure_action: "block"
      success_criteria:
        - "0 security vulnerabilities"
        - "all inputs validated"
        - "no hardcoded secrets"

    # Code Quality Gate - Biome Validation
    - name: "Code Quality Standards"
      command: "biome check --apply=off"
      blocking: true
      timeout: 30
      description: "Biome rules compliance"
      failure_action: "block"
      success_criteria:
        - "0 linting errors"
        - "consistent formatting"
        - "naming conventions followed"

    # Test Coverage Gate - 90% Minimum
    - name: "Test Coverage Validation"
      command: "smart_test --coverage --threshold=90"
      blocking: true
      timeout: 300
      description: "90% test coverage minimum"
      failure_action: "block"
      success_criteria:
        - "coverage >= 90%"
        - "all critical paths tested"
        - "edge cases covered"

    # Input Validation Gate - Defensive Programming
    - name: "Input Validation Check"
      command: "smart_grep --pattern='z\\..*\\.parse\\(' --validate-coverage"
      blocking: true
      timeout: 30
      description: "All inputs must be validated"
      failure_action: "block"
      success_criteria:
        - "all external inputs validated with Zod"
        - "no direct object access without validation"
        - "boundary checks present"

  advisory:
    # Performance Regression - Warning only
    - name: "Performance Regression Check"
      command: "smart_performance --baseline-comparison"
      blocking: false
      timeout: 60
      description: "Alert on performance degradation"
      failure_action: "warn"
      success_criteria:
        - "performance within 5% of baseline"
        - "no memory leaks detected"
        - "response times acceptable"

    # Documentation Update
    - name: "Documentation Consistency"
      command: "smart_docs --validate-sync"
      blocking: false
      timeout: 30
      description: "Documentation matches implementation"
      failure_action: "warn"
      success_criteria:
        - "API docs updated"
        - "README reflects changes"
        - "comments are current"

# Zero Defect Patterns Validation
pattern_validation:
  required_patterns:
    # Input validation pattern
    - pattern: "z\\.(object|string|number|array).*\\.parse\\("
      description: "Input validation with Zod required"
      files: "**/*.ts"
      minimum_occurrences: 1
      scope: "functions_with_external_input"

    # Error handling pattern
    - pattern: "Result<.*,.*>"
      description: "Result pattern for error handling"
      files: "**/*.ts"
      minimum_occurrences: 1
      scope: "functions_that_can_fail"

    # Type assertion prevention
    - pattern: "as\\s+(any|unknown)"
      description: "Type assertions should be avoided"
      files: "**/*.ts"
      maximum_occurrences: 0
      violation: "error"

  forbidden_patterns:
    # Forbidden: any type usage
    - pattern: ":\\s*any\\b"
      description: "any type is forbidden - use unknown with type guards"
      files: "**/*.ts"
      violation: "error"

    # Forbidden: eval usage
    - pattern: "eval\\s*\\("
      description: "eval is forbidden for security reasons"
      files: "**/*.(js|ts)"
      violation: "error"

    # Forbidden: innerHTML with variables
    - pattern: "innerHTML\\s*=\\s*[^\"']"
      description: "innerHTML with variables forbidden - use textContent"
      files: "**/*.(js|ts|jsx|tsx)"
      violation: "error"

# Security Validation Rules
security_rules:
  authentication:
    - check: "Protected routes have auth validation"
      command: "@security-auditor --auth-flow-analysis" 
      required: true

  input_sanitization:
    - check: "All user inputs are sanitized"
      pattern: "sanitize|escape|validate"
      required: true

  secrets_detection:
    - check: "No hardcoded secrets"
      command: "smart_grep --pattern='(password|secret|key|token)\\s*=\\s*[\"'']'"
      forbidden: true

# Performance Validation
performance_checks:
  memory_usage:
    - check: "No memory leaks detected"
      command: "smart_performance --memory-leak-detection"
      threshold: "0 leaks"

  response_time:
    - check: "API response times acceptable"
      command: "smart_performance --response-time-check"
      threshold: "< 200ms for critical paths"

  bundle_size:
    - check: "Bundle size within limits"
      command: "smart_build --analyze-bundle"
      threshold: "< 1MB for main bundle"

# Emergency Override (USE WITH EXTREME CAUTION)
emergency_override:
  enabled: false  # Must be manually enabled
  authorization_required: true
  audit_log: true
  justification_required: true
  automatic_revert: true
  
  conditions:
    - "Production hotfix for critical security vulnerability"
    - "System outage requiring immediate fix"
    - "Approved emergency change request"

  restrictions:
    - "Override expires in 24 hours"
    - "Full validation required within 48 hours"
    - "Root cause analysis mandatory"
    - "Process improvement plan required"

# Notification Configuration
notifications:
  on_failure:
    - type: "blocking"
      message: "❌ COMMIT BLOCKED: Zero Defect validation failed"
      details: "Fix all errors before proceeding. NO EXCEPTIONS."
    
    - type: "email"
      recipients: ["team-lead@company.com"]
      subject: "Zero Defect Gate Failure: {project_name}"
    
  on_success:
    - type: "confirmation"
      message: "✅ Zero Defect validation passed - commit authorized"

# Metrics and Reporting
metrics:
  track:
    - "gate_success_rate"
    - "most_common_failures"
    - "time_to_fix_issues"
    - "developer_compliance_rate"
  
  reporting:
    - frequency: "daily"
      format: "dashboard"
    - frequency: "weekly" 
      format: "detailed_report"
    - frequency: "monthly"
      format: "trend_analysis"